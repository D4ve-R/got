#!/usr/bin/env python3
import sys
import os
import subprocess
import requests

# check env for openai api key, if not present check in $HOME/.config/got/credentials, if not present ask for it
if 'OPENAI_API_KEY' in os.environ:
    openai_api_key = os.environ['OPENAI_API_KEY']
else:
    try:
        with open(os.path.join(os.environ['HOME'], '.config', 'got', 'token'), 'r') as f:
            openai_api_key = f.read().strip()
    except FileNotFoundError:
        key = input("Please enter your OpenAI API key: ").strip()
        openai_api_key = key
        os.environ['OPENAI_API_KEY'] = key
        path = os.path.join(os.environ['HOME'], '.config', 'got')
        os.makedirs(path, exist_ok=True)
        with open(os.path.join(path, 'token'), 'w') as f:
            f.write(key)


def generate_commit_message(diff):
    messages = [
        {"role": "system", "content": "Generate good commit messages based on git diff, output must not exceed 72 characters and must be only the message without additional text."},
    ]
    # Call OpenAI GPT-3 to generate a commit message based on the diff
    prompt = f"Generate a commit message based on the following:\n{diff}"
    messages.append({"role": "user", "content": prompt})
    data = {
        "model": "gpt-3.5-turbo",
        "messages": messages,
    }
    response = requests.post(
        "https://api.openai.com/v1/chat/completions",
        headers={"Authorization": f"Bearer {openai_api_key}"},
        json=data,
    )

    response = response.json()
    return response.choices[0].message.content

def git_commit(*args):
    if args == ("commit",):
        diff = subprocess.check_output(["git", "diff"]).decode("utf-8")
        commit_message = generate_commit_message(diff)
        subprocess.run(["git", "commit", "-m", commit_message])
    else:
        subprocess.run(["git"] + list(args))

if __name__ == "__main__":
    git_commit(*sys.argv[1:])
